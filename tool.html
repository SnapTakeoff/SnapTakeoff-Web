<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapTakeoff Prime</title>
    <link rel="icon" href="/favicon.ico">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        /* --- CORE APP LAYOUT --- */
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; font-family: 'Helvetica Neue', sans-serif; overflow: hidden; 
            display: flex; flex-direction: column; height: 100vh; background-color: #111827; 
        }

        /* HEADER */
        .navbar {
            height: 50px; background-color: #0a0e17; display: flex; align-items: center;
            justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #1f2937; flex-shrink: 0; z-index: 60;
        }
        .logo { font-size: 20px; font-weight: 800; color: white; text-decoration: none; }
        .highlight { color: #FFC107; }

        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        /* HEADER BUTTONS & INPUTS */
        .header-btn, .header-select {
            padding: 6px 12px; border-radius: 4px; font-weight: bold; font-size: 13px; cursor: pointer; 
            border: 1px solid white; background: white; color: #0a0e17; transition: 0.2s;
        }
        .header-btn:hover, .header-select:hover {
            background: #2563eb; color: white; border-color: #2563eb;   
        }
        
        .header-btn.active {
            background: #2563eb; color: white; border-color: #2563eb;
        }

        /* DOWNLOAD BUTTON */
        .btn-dl { background: white; color: #2563eb; border: 1px solid #2563eb; transition: 0.2s; }
        .btn-dl:hover { background: #2563eb; color: white; }

        /* APP BODY */
        .app-body { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* CENTER WORKSPACE */
        .workspace-center { flex: 1; display: flex; flex-direction: column; background-color: #f3f4f6; position: relative; min-width: 0; }

        /* --- FLOATING TOOLBAR (LEFT) --- */
        .floating-toolbar {
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; 
            background: #d1d5db; padding: 5px; 
            border-radius: 8px;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.4); border: 1px solid #9ca3af;
            z-index: 50; max-height: 80%; 
        }

        .toolbar-inner {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
            scrollbar-width: none; padding: 5px 0; 
        }
        .toolbar-inner::-webkit-scrollbar { width: 0px; }

        .scroll-btn-v {
            background: transparent; border: none; color: #4b5563;
            cursor: pointer; font-size: 12px; height: 20px; width: 100%;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; border-radius: 4px;
        }
        .scroll-btn-v:hover { background: rgba(0,0,0,0.1); color: #000; }

        .tool-btn {
            background: white; border: 1px solid #9ca3af; color: #0a0e17;
            width: 40px; height: 40px; border-radius: 6px; font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; position: relative; flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tool-btn:hover { background: #f9fafb; border-color: #6b7280; }
        .tool-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        
        .tool-btn::after {
            content: attr(data-tooltip);
            position: absolute; left: 50px; top: 50%; transform: translateY(-50%);
            background: #000; color: #fff; padding: 4px 8px; font-size: 11px;
            border-radius: 4px; white-space: nowrap; opacity: 0; pointer-events: none; transition: 0.2s;
            font-weight: bold; font-family: sans-serif; z-index: 60;
        }
        .tool-btn:hover::after { opacity: 1; }

        .tool-sep { height: 1px; background: #9ca3af; margin: 2px 0; width: 100%; flex-shrink: 0; }

        /* --- CENTER UPLOAD AREA --- */
        .upload-center {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #4b5563; 
        }
        .upload-box {
            background: white; padding: 40px; border-radius: 12px; border: 2px dashed #9ca3af;
            text-align: center; width: 400px; max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .upload-icon { font-size: 60px; margin-bottom: 20px; display: block; color: #FFC107; }
        .upload-text { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #1f2937; }
        
        .center-btn {
            background: #2563eb; color: white; border: none; padding: 12px 24px;
            border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;
            margin-top: 15px; width: 100%; transition: 0.2s;
        }
        .center-btn:hover { background: #1d4ed8; }
        .center-file-input {
            background: #f3f4f6; color: #1f2937; padding: 10px; border-radius: 6px;
            width: 100%; margin-bottom: 10px; border: 1px solid #d1d5db;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; display: flex;
            align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; width: 450px; max-width: 90%; max-height: 85vh;
            overflow-y: auto; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            padding: 30px; position: relative;
        }
        .modal-close {
            position: absolute; top: 15px; right: 20px; font-size: 24px;
            font-weight: bold; cursor: pointer; color: #6b7280;
        }
        .modal-title { 
            font-size: 20px; font-weight: 800; margin-bottom: 25px; 
            color: #1f2937; border-bottom: 2px solid #FFC107; display: inline-block; padding-bottom: 5px; 
        }
        
        .config-row { margin-bottom: 20px; }
        .config-label { font-size: 13px; font-weight: bold; color: #374151; margin-bottom: 8px; display: block; }
        .slider-flex { display: flex; align-items: center; gap: 10px; }
        .slider-flex input[type=range] { flex-grow: 1; accent-color: #2563eb; height: 6px; }
        .slider-flex input[type=number] { 
            width: 60px; padding: 5px; text-align: center; border: 1px solid #d1d5db; 
            border-radius: 4px; font-weight: bold; font-size: 14px;
        }

        /* --- ROOM CHIPS --- */
        .active-project-chips { 
            position: absolute; top: 20px; right: 20px; bottom: auto; left: auto;
            display: flex; flex-direction: column; gap: 8px; pointer-events: none;
            align-items: flex-end; z-index: 40;
        }
        .room-chip { 
            pointer-events: auto; background: rgba(50, 205, 50, 0.95); 
            color: white; padding: 6px 12px; border-radius: 20px; 
            font-size: 12px; font-weight: bold; display: flex; 
            align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid white;
        }
        .room-chip .del-btn { cursor: pointer; font-weight: 900; font-size: 14px; opacity: 0.8; }

        .canvas-container {
            flex: 1; overflow: auto; display: flex; align-items: center; justify-content: center;
            background: transparent; padding: 10px; position: relative;
        }
        canvas { 
            box-shadow: 0 5px 25px rgba(0,0,0,0.2); background: white; 
            max-width: 100%; max-height: 100%; object-fit: contain;
        }

        /* FOOTER */
        .footer-bar {
            height: 70px; background-color: #d1d5db; color: #0a0e17; 
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px; 
            border-top: 1px solid #9ca3af; flex-shrink: 0; z-index: 30;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        }
        .footer-group { display: flex; gap: 15px; align-items: center; }
        
        .metric-mini {
            background: white; padding: 5px 12px; border-radius: 4px; 
            border: 1px solid #9ca3af; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .metric-mini label { display: block; font-size: 9px; color: #4b5563; margin-bottom: 2px; text-transform: uppercase; font-weight: bold; }
        .metric-mini .val { font-size: 15px; font-weight: 900; color: #0a0e17; font-family: monospace; }
        
        .input-mini {
            background: #f9fafb; border: 1px solid #9ca3af; color: #0a0e17;
            width: 60px; padding: 4px; text-align: center; font-size: 13px; font-weight: bold; border-radius: 4px;
        }

        .hidden { display: none !important; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 23, 0.95);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #FFC107;
        }
        .spinner {
            border: 6px solid #30363d; border-top: 6px solid #FFC107; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script>
        function syncInputs(sourceId, targetId) { document.getElementById(targetId).value = document.getElementById(sourceId).value; }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function updateSens(source) {
            const slider = document.getElementById('ui_sens_slider'); const num = document.getElementById('ui_sens_num'); const hidden = document.getElementById('real_thresh');
            let val = 0; if(source === 'slider') { val = parseInt(slider.value); num.value = val; } else { val = parseInt(num.value); slider.value = val; }
            const inverted = Math.floor(200 - (val * 1.8)); hidden.value = inverted;
        }
        function initSens(serverThresh) {
            const sens = Math.round((200 - serverThresh) / 1.8); document.getElementById('ui_sens_slider').value = sens;
            document.getElementById('ui_sens_num').value = sens; document.getElementById('real_thresh').value = serverThresh;
        }
        function scrollRibbon(direction) { document.getElementById('ribbonContent').scrollBy({ left: direction * 150, behavior: 'smooth' }); }
        function scrollToolbar(direction) { document.getElementById('toolbarContent').scrollBy({ top: direction * 60, behavior: 'smooth' }); }
        
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function checkFreeTrial() { if (localStorage.getItem('snaptakeoff_trial_used')) { const btn = document.getElementById('btn-free-trial'); if(btn) btn.classList.add('hidden'); } }
        function useFreeTrial() { if(confirm("üéÅ Use your 1-time FREE UNLOCK now?")) { localStorage.setItem('snaptakeoff_trial_used', 'true'); document.getElementById('download_form').submit(); } }
        function startPayment() { var options = { "key": "rzp_test_YOUR_KEY_HERE", "amount": "19900", "currency": "INR", "name": "SnapTakeoff Pro", "description": "Unlock Excel Estimate", "image": "/favicon.ico", "theme": { "color": "#FFC107" }, "handler": function (response){ document.getElementById('download_form').submit(); } }; var rzp1 = new Razorpay(options); rzp1.open(); return false; }

        let areaPoints = []; let savedAreas = []; let countPoints = []; let scalePoints = []; let measurePoints = [];
        let mode = 'none'; let currentCategory = 'elec'; let isLoupeEnabled = false; 
        let canvas, ctx, bgImage; let mouseX = 0, mouseY = 0;
        let currentZoom = 1.0; let isPanning = false; let startPanX = 0, startPanY = 0;

        function initCanvas(imgDataStr) {
            canvas = document.getElementById('blueprintCanvas'); ctx = canvas.getContext('2d');
            bgImage = new Image();
            bgImage.onload = function() { canvas.width = bgImage.width; canvas.height = bgImage.height; redrawCanvas(); setZoom('fit'); 
            initTooltips(); 
            };
            bgImage.src = "data:image/jpeg;base64," + imgDataStr;

            canvas.addEventListener('mousemove', function(e) {
                if(mode === 'pan' && isPanning) { const container = document.querySelector('.canvas-container'); container.scrollLeft = startPanX - e.clientX; container.scrollTop = startPanY - e.clientY; return; }
                const rect = canvas.getBoundingClientRect(); const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
                mouseX = (e.clientX - rect.left) * scaleX; mouseY = (e.clientY - rect.top) * scaleY; redrawCanvas();
            });
            canvas.addEventListener('mousedown', function(e) {
                if (mode === 'pan') { isPanning = true; const container = document.querySelector('.canvas-container'); startPanX = container.scrollLeft + e.clientX; startPanY = container.scrollTop + e.clientY; canvas.style.cursor = 'grabbing'; return; }
                if (mode === 'none') return;
                const rect = canvas.getBoundingClientRect(); const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX; const y = (e.clientY - rect.top) * scaleY;
                if (mode === 'area') { areaPoints.push({x, y}); calcArea(); } 
                else if (mode === 'count') { countPoints.push({x, y, type: currentCategory}); updateCountDisplay(); recalc(); } 
                else if (mode === 'scale') { scalePoints.push({x, y}); if (scalePoints.length === 2) { redrawCanvas(); setTimeout(finalizeScale, 50); } } 
                else if (mode === 'measure') { measurePoints.push({x, y}); redrawCanvas(); }
                redrawCanvas();
            });
            canvas.addEventListener('mouseup', function() { if (mode === 'pan') { isPanning = false; canvas.style.cursor = 'grab'; } });
            canvas.addEventListener('mouseleave', function() { isPanning = false; });
        }

        function initTooltips() {
            const tooltip = document.createElement('div');
            tooltip.style.cssText = "position:fixed; background:#0a0e17; color:white; padding:6px 10px; border-radius:4px; font-size:12px; font-weight:bold; pointer-events:none; display:none; z-index:9999; box-shadow:2px 2px 5px rgba(0,0,0,0.2); white-space:nowrap;";
            document.body.appendChild(tooltip);
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    const text = btn.getAttribute('data-tooltip');
                    if(text) {
                        tooltip.innerText = text; tooltip.style.display = 'block';
                        const rect = btn.getBoundingClientRect();
                        tooltip.style.left = (rect.right + 10) + 'px'; tooltip.style.top = (rect.top + (rect.height/2) - (tooltip.offsetHeight/2)) + 'px';
                    }
                });
                btn.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });
            });
        }

        function toggleLoupe() {
            isLoupeEnabled = !isLoupeEnabled;
            const btn = document.getElementById('btnLoupeToggle');
            if(isLoupeEnabled) btn.classList.add('active');
            else btn.classList.remove('active');
            redrawCanvas();
        }

        // --- CURRENCY CONVERTER LOGIC ---
        let currentRate = 1.0; 
        const rates = {
            '$': 1.0,
            '‚Çπ': 86.0,
            '‚Ç¨': 0.92,
            '¬£': 0.78,
            'C$': 1.35,
            'A$': 1.50,
            '¬•': 145.0
        };

        function updateCurrency(select) {
            const newSymbol = select.value;
            const newRate = rates[newSymbol] || 1.0;
            const ratio = newRate / currentRate;
            
            const ids = ['cost_sheet', 'cost_paint', 'cost_elec', 'cost_plumb', 'cost_hvac'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                const oldVal = parseFloat(el.value) || 0;
                let newVal = oldVal * ratio;
                if(newRate > 50) newVal = Math.round(newVal); 
                else newVal = parseFloat(newVal.toFixed(2));
                el.value = newVal;
            });

            currentRate = newRate;
            recalc();
        }

        // --- SAVE & LOAD ---
        function saveProject() {
            if(!bgImage) return alert("No blueprint to save!");
            const projectData = {
                imageData: bgImage.src,
                savedAreas: savedAreas,
                countPoints: countPoints,
                scalePoints: scalePoints,
                rawWidthStore: document.getElementById('raw_width_store').value,
                realWidth: document.getElementById('real_width_input').value,
                costSheet: document.getElementById('cost_sheet').value,
                costPaint: document.getElementById('cost_paint').value,
                currency: document.getElementById('currency_select').value
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "snaptakeoff_project.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadProject(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    bgImage = new Image();
                    bgImage.onload = function() {
                        canvas.width = bgImage.width;
                        canvas.height = bgImage.height;
                        
                        savedAreas = data.savedAreas || [];
                        countPoints = data.countPoints || [];
                        scalePoints = data.scalePoints || [];
                        
                        document.getElementById('raw_width_store').value = data.rawWidthStore || 1;
                        document.getElementById('real_width_input').value = data.realWidth || 50;
                        document.getElementById('cost_sheet').value = data.costSheet || 15;
                        document.getElementById('cost_paint').value = data.costPaint || 40;
                        document.getElementById('currency_select').value = data.currency || '$';
                        
                        // Update currentRate based on loaded currency
                        currentRate = rates[data.currency] || 1.0;

                        renderRoomList();
                        recalc();
                        redrawCanvas();
                        setZoom('fit');
                        alert("Project loaded successfully!");
                    };
                    bgImage.src = data.imageData;
                } catch(err) { alert("Error loading project file."); }
            };
            reader.readAsText(file);
        }

        function setZoom(val) {
            if(!canvas) return;
            if(val === 'fit') { canvas.style.maxWidth = '100%'; canvas.style.maxHeight = '100%'; canvas.style.width = 'auto'; canvas.style.height = 'auto'; } 
            else { const scale = parseFloat(val); const newWidth = canvas.width * scale; canvas.style.maxWidth = 'none'; canvas.style.maxHeight = 'none'; canvas.style.width = newWidth + 'px'; canvas.style.height = 'auto'; }
        }

        function setMode(newMode) {
            mode = (mode === newMode) ? 'none' : newMode; 
            if (mode !== 'scale') scalePoints = [];
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('catSelector').classList.add('hidden'); document.getElementById('btnSaveArea').classList.add('hidden'); 
            
            if (mode === 'none') canvas.style.cursor = 'default'; else canvas.style.cursor = 'crosshair';
            
            if (mode === 'area') { document.getElementById('btnAreaMode').classList.add('active'); document.getElementById('btnSaveArea').classList.remove('hidden'); }
            if (mode === 'count') { document.getElementById('btnCountMode').classList.add('active'); document.getElementById('catSelector').classList.remove('hidden'); }
            if (mode === 'scale') document.getElementById('btnScaleMode').classList.add('active');
            if (mode === 'measure') document.getElementById('btnMeasureMode').classList.add('active');
            if (mode === 'pan') { document.getElementById('btnPanMode').classList.add('active'); canvas.style.cursor = 'grab'; }
            redrawCanvas();
        }

        function finalizeScale() {
            let ft = prompt("Enter real-world length (Feet):", "3.0");
            if (ft && !isNaN(ft) && parseFloat(ft) > 0) {
                let p1 = scalePoints[0], p2 = scalePoints[1];
                let distPx = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
                let pxPerFt = distPx / parseFloat(ft);
                let rawWidth = parseFloat(document.getElementById('raw_width_store').value);
                document.getElementById('real_width_input').value = (rawWidth / pxPerFt).toFixed(2);
                alert("Scale Calibrated!"); recalc(); 
            }
            scalePoints = []; setMode('none'); redrawCanvas();
        }
        function saveCurrentArea() {
            if(areaPoints.length < 3) return alert("Draw area first.");
            let name = prompt("Area Name:", "Room " + (savedAreas.length + 1));
            if(name) { savedAreas.push({ name: name, points: [...areaPoints] }); areaPoints = []; renderRoomList(); recalc(); redrawCanvas(); }
        }
        function undoAction() {
            if (mode === 'area' && areaPoints.length > 0) { areaPoints.pop(); calcArea(); } 
            else if (mode === 'count' && countPoints.length > 0) { countPoints.pop(); updateCountDisplay(); recalc(); } 
            else if (mode === 'measure' && measurePoints.length > 0) { measurePoints.pop(); } 
            redrawCanvas();
        }
        function clearTools() { if(confirm("Clear All?")) { areaPoints=[]; savedAreas=[]; countPoints=[]; scalePoints=[]; measurePoints=[]; setMode('none'); renderRoomList(); redrawCanvas(); recalc(); } }
        function downloadCanvas() { var link = document.createElement('a'); link.download = 'SnapTakeoff.png'; link.href = canvas.toDataURL("image/png"); link.click(); }
        function renderRoomList() {
            const container = document.getElementById('roomListOverlay'); container.innerHTML = "";
            savedAreas.forEach((room, index) => {
                const chip = document.createElement('div'); chip.className = 'room-chip';
                chip.innerHTML = `<span>${room.name}</span> <span class="del-btn" onclick="deleteRoom(${index})">√ó</span>`;
                container.appendChild(chip);
            });
        }
        function deleteRoom(i) { savedAreas.splice(i, 1); renderRoomList(); recalc(); redrawCanvas(); }

        function redrawCanvas() {
            if(!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(bgImage, 0, 0);

            for(let room of savedAreas) {
                if(room.points.length > 0) {
                    ctx.beginPath(); ctx.moveTo(room.points[0].x, room.points[0].y);
                    for(let i=1; i<room.points.length; i++) ctx.lineTo(room.points[i].x, room.points[i].y);
                    ctx.closePath(); ctx.fillStyle = "rgba(50, 205, 50, 0.4)"; ctx.fill();
                    ctx.lineWidth = 2; ctx.strokeStyle = "#32CD32"; ctx.stroke();
                    let cx=0, cy=0; room.points.forEach(p=>{cx+=p.x; cy+=p.y;}); cx/=room.points.length; cy/=room.points.length;
                    ctx.fillStyle = "white"; ctx.font = "bold 20px Arial"; ctx.strokeStyle="black"; ctx.lineWidth=3;
                    ctx.strokeText(room.name, cx-20, cy); ctx.fillText(room.name, cx-20, cy);
                }
            }
            if (areaPoints.length > 0) {
                ctx.beginPath(); ctx.moveTo(areaPoints[0].x, areaPoints[0].y);
                for (let i=1; i<areaPoints.length; i++) ctx.lineTo(areaPoints[i].x, areaPoints[i].y);
                ctx.closePath(); ctx.fillStyle = "rgba(255, 193, 7, 0.3)"; ctx.fill();
                ctx.lineWidth = 4; ctx.strokeStyle = "#FFC107"; ctx.stroke();
                ctx.fillStyle = "red"; areaPoints.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill(); });
            }
            ctx.lineWidth = 2; ctx.strokeStyle = "white";
            countPoints.forEach(p => {
                ctx.beginPath(); ctx.fillStyle = p.type === 'elec' ? "#00FFFF" : (p.type === 'plumb' ? "#FF4500" : "#32CD32");
                ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            });
            if(scalePoints.length > 0) {
                ctx.strokeStyle = "#FF00FF"; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(scalePoints[0].x, scalePoints[0].y);
                if(scalePoints[1]) ctx.lineTo(scalePoints[1].x, scalePoints[1].y); ctx.stroke();
            }
            const rawWidth = parseFloat(document.getElementById('raw_width_store').value || 1);
            let realFt = parseFloat(document.getElementById('real_width_input').value || 1);
            const scale = rawWidth / realFt;
            for (let i=0; i<measurePoints.length; i+=2) {
                if (i+1 < measurePoints.length) {
                    let p1 = measurePoints[i], p2 = measurePoints[i+1];
                    ctx.strokeStyle = "#FFA500"; ctx.lineWidth = 3; ctx.setLineDash([10, 5]);
                    ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); ctx.setLineDash([]);
                    let dist = (Math.sqrt(Math.pow(p2.x-p1.x, 2) + Math.pow(p2.y-p1.y, 2)) / scale).toFixed(2) + " ft";
                    let mx = (p1.x+p2.x)/2, my = (p1.y+p2.y)/2;
                    ctx.fillStyle="black"; ctx.fillRect(mx-110, my-30, 220, 60);
                    ctx.fillStyle="#FFA500"; ctx.font="bold 40px monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(dist, mx, my);
                } else {
                    ctx.fillStyle = "#FFA500"; ctx.beginPath(); ctx.arc(measurePoints[i].x, measurePoints[i].y, 5, 0, Math.PI*2); ctx.fill();
                }
            }
            if (isLoupeEnabled && mode !== 'none' && mode !== 'pan') {
                const r = 75, zoom = 4;
                ctx.save(); ctx.beginPath(); ctx.arc(mouseX, mouseY, r, 0, Math.PI*2); ctx.clip();
                ctx.fillStyle = "white"; ctx.fillRect(mouseX-r, mouseY-r, r*2, r*2);
                ctx.drawImage(bgImage, mouseX-r/zoom, mouseY-r/zoom, (r*2)/zoom, (r*2)/zoom, mouseX-r, mouseY-r, r*2, r*2);
                ctx.strokeStyle = "#00FFFF"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(mouseX-10, mouseY); ctx.lineTo(mouseX+10, mouseY); ctx.moveTo(mouseX, mouseY-10); ctx.lineTo(mouseX, mouseY+10); ctx.stroke(); ctx.restore();
                ctx.beginPath(); ctx.arc(mouseX, mouseY, r, 0, Math.PI*2); ctx.lineWidth=3; ctx.strokeStyle="white"; ctx.stroke();
            }
        }

        function getPolyArea(points) {
            if(points.length<3) return 0; let area=0; for(let i=0; i<points.length; i++) { let j=(i+1)%points.length; area += points[i].x*points[j].y; area -= points[j].x*points[i].y; } return Math.abs(area)/2;
        }
        function updateCountDisplay() {}
        function recalc() {
            try {
                document.getElementById('disp_count').innerText = countPoints.length;
                const rawWidth = parseFloat(document.getElementById('raw_width_store').value);
                let realFt = parseFloat(document.getElementById('real_width_input').value) || 1;
                const scale = rawWidth / realFt;
                
                let totalSqFt = 0; let breakdown = [];
                for(let r of savedAreas) { let ft = getPolyArea(r.points) / (scale*scale); totalSqFt += ft; breakdown.push({name: r.name, sqft: ft.toFixed(2)}); }
                let currentFt = getPolyArea(areaPoints) / (scale*scale); totalSqFt += currentFt;
                
                document.getElementById('disp_area').innerText = totalSqFt.toFixed(2);
                document.getElementById('hidden_area').value = totalSqFt.toFixed(2);
                document.getElementById('hidden_area_breakdown').value = JSON.stringify(breakdown);

                const rawPixels = parseFloat(document.getElementById('raw_pixels_store').value);
                const totalLinearFt = rawPixels / scale;
                document.getElementById('disp_feet').innerText = totalLinearFt.toFixed(2);

                let wasteVal = document.getElementById('waste_slider').value;
                let waste = 1 + (parseFloat(wasteVal)/100);
                document.getElementById('waste_display').innerText = wasteVal + "%";

                let pSheet = parseFloat(document.getElementById('cost_sheet').value) || 0;
                let pPaint = parseFloat(document.getElementById('cost_paint').value) || 0;
                let sheets = ((totalLinearFt * 8) / 32) * waste;
                let paint = ((totalLinearFt * 8) / 400) * waste;
                
                let cElec = parseFloat(document.getElementById('cost_elec').value) || 0;
                let cPlumb = parseFloat(document.getElementById('cost_plumb').value) || 0;
                let cHvac = parseFloat(document.getElementById('cost_hvac').value) || 0;
                let nElec=0, nPlumb=0, nHvac=0;
                countPoints.forEach(p => { if(p.type==='elec') nElec++; else if(p.type==='plumb') nPlumb++; else nHvac++; });

                let totalCost = (sheets*pSheet) + (paint*pPaint) + (nElec*cElec) + (nPlumb*cPlumb) + (nHvac*cHvac);
                
                let cur = document.getElementById('currency_select').value;
                document.getElementById('lbl_sheet').innerText = "Sheet " + cur;
                document.getElementById('lbl_paint').innerText = "Paint " + cur;
                document.getElementById('disp_cost').innerText = cur + totalCost.toFixed(2);

                document.getElementById('hidden_currency').value = cur;
                document.getElementById('hidden_feet').value = totalLinearFt.toFixed(2);
                document.getElementById('hidden_cost').value = totalCost.toFixed(2);
                document.getElementById('hidden_sheets').value = sheets;
                document.getElementById('hidden_paint').value = paint;
                document.getElementById('hidden_count_elec').value = nElec;
                document.getElementById('hidden_count_plumb').value = nPlumb;
                document.getElementById('hidden_count_hvac').value = nHvac;
                document.getElementById('hidden_waste_percent').value = wasteVal;

                checkFreeTrial();
            } catch(e) {}
        }
    </script>
</head>
<body onload="checkFreeTrial(); {% if result %}initSens({{ params.thresh }});{% endif %}">

    <div id="configModal" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('configModal')">
        <div class="modal-box">
            <span class="modal-close" onclick="closeModal('configModal')">&times;</span>
            <div class="modal-title">Sensor Configuration</div>
            
            <div class="config-row"><label class="config-label">Sensitivity (Detection Power)</label><div class="slider-flex"><input type="range" id="ui_sens_slider" min="0" max="100" value="83" oninput="updateSens('slider')" form="scan-form"><input type="number" id="ui_sens_num" value="83" oninput="updateSens('num')" form="scan-form"><input type="hidden" id="real_thresh" name="thresh" value="50" form="scan-form"></div></div>
            <div class="config-row"><label class="config-label">Gap Fill</label><div class="slider-flex"><input type="range" id="range_gap" name="gap" min="5" max="100" value="{{ params.gap }}" oninput="syncInputs('range_gap', 'num_gap')" form="scan-form"><input type="number" id="num_gap" value="{{ params.gap }}" oninput="syncInputs('num_gap', 'range_gap')" form="scan-form"></div></div>
            <div class="config-row"><label class="config-label">Min Wall Length</label><div class="slider-flex"><input type="range" id="range_len" name="min_len" min="50" max="500" value="{{ params.min_len }}" oninput="syncInputs('range_len', 'num_len')" form="scan-form"><input type="number" id="num_len" value="{{ params.min_len }}" oninput="syncInputs('num_len', 'range_len')" form="scan-form"></div></div>
            <div class="config-row"><label class="config-label">Wall Thickness</label><div class="slider-flex"><input type="range" id="range_thick" name="thick" min="1" max="10" value="{{ params.thick }}" oninput="syncInputs('range_thick', 'num_thick')" form="scan-form"><input type="number" id="num_thick" value="{{ params.thick }}" oninput="syncInputs('num_thick', 'range_thick')" form="scan-form"></div></div>
            
            <button onclick="closeModal('configModal')" style="width:100%; padding:10px; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">Done</button>
        </div>
    </div>

    <div id="guideModal" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('guideModal')">
        <div class="modal-box">
            <span class="modal-close" onclick="closeModal('guideModal')">&times;</span>
            <div class="modal-title">Controls Guide</div>
            <div class="modal-text"><b>üìè Scale:</b> First step! Draw line over known length -> Enter feet.<br><b>üìê Area:</b> Click room corners -> Click 'Save'.<br><b>üëÜ Count:</b> Click items to count.<br><b>‚úã Pan:</b> Drag to move blueprint.<br><b>üîç Zoom:</b> Use dropdown or scroll.</div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div><h2 style="font-family: monospace;">PROCESSING...</h2>
    </div>

    <div class="navbar">
        <a href="/" class="logo">Snap<span class="highlight">Takeoff</span></a>
        
        {% if result %}
        <div class="header-actions">
            <select class="header-select" onchange="setZoom(this.value)" style="margin-right:10px;">
                <option value="fit">Fit to Screen</option>
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
                <option value="1.0" selected>100% (Actual)</option>
                <option value="1.5">150%</option>
                <option value="2.0">200%</option>
                <option value="3.0">300%</option>
                <option value="4.0">400%</option>
            </select>

            <button id="btnLoupeToggle" onclick="toggleLoupe()" class="header-btn">üîç Magnifier</button>

            <button onclick="openModal('configModal')" class="header-btn">‚öôÔ∏è Sensor Config</button>
            <button onclick="saveProject()" class="header-btn">üíæ Save</button>
            <button onclick="document.getElementById('loadProjectInput').click()" class="header-btn">üìÇ Load</button>
            <input type="file" id="loadProjectInput" style="display:none" onchange="loadProject(this)" accept=".json">
            <button onclick="openGuide()" class="header-btn">‚ÑπÔ∏è Guide</button>

            <form id="download_form" action="/download_report" method="post" style="display:flex; gap:10px;">
                <input type="hidden" name="final_feet" id="hidden_feet"><input type="hidden" name="final_cost" id="hidden_cost">
                <input type="hidden" name="final_sheets" id="hidden_sheets"><input type="hidden" name="final_paint" id="hidden_paint">
                <input type="hidden" name="final_area" id="hidden_area"><input type="hidden" name="area_breakdown" id="hidden_area_breakdown">
                <input type="hidden" name="currency_symbol" id="hidden_currency"><input type="hidden" name="unit_price_sheet" id="hidden_unit_sheet">
                <input type="hidden" name="unit_price_paint" id="hidden_unit_paint"><input type="hidden" name="count_elec" id="hidden_count_elec">
                <input type="hidden" name="count_plumb" id="hidden_count_plumb"><input type="hidden" name="count_hvac" id="hidden_count_hvac">
                <input type="hidden" name="waste_percent" id="hidden_waste_percent">

                <button type="button" id="btn-free-trial" onclick="useFreeTrial()" class="header-btn">üéÅ Free Trial</button>
                <button type="button" onclick="startPayment()" class="header-btn btn-dl">üîì Download Excel (199/-)</button>
            </form>
        </div>
        {% endif %}
    </div>

    <div class="app-body">
        
        <div class="workspace-center">
            {% if result %}
            <input type="hidden" id="raw_pixels_store" value="{{ raw_pixels }}">
            <input type="hidden" id="raw_width_store" value="{{ raw_width }}">

            <div class="floating-toolbar">
                <button class="scroll-btn-v" onclick="scrollToolbar(-1)">‚ñ≤</button>
                <div class="toolbar-inner" id="toolbarContent">
                    <button class="tool-btn" id="btnScaleMode" onclick="setMode('scale')" data-tooltip="Calibrate Scale">üìè</button>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" id="btnAreaMode" onclick="setMode('area')" data-tooltip="Measure Area">üìê</button>
                    <button class="tool-btn hidden" id="btnSaveArea" onclick="saveCurrentArea()" style="color:#2ea043; font-weight:900;" data-tooltip="Save Area">üíæ</button>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" id="btnCountMode" onclick="setMode('count')" data-tooltip="Count Items">üëÜ</button>
                    <select id="catSelector" class="hidden" onchange="currentCategory=this.value" style="font-size:10px; width:40px;"><option value="elec">‚ö°</option><option value="plumb">üöø</option><option value="hvac">‚ùÑÔ∏è</option></select>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" id="btnMeasureMode" onclick="setMode('measure')" data-tooltip="Tape Measure">üìè</button>
                    <button class="tool-btn" id="btnPanMode" onclick="setMode('pan')" data-tooltip="Pan View">‚úã</button>
                    <div class="tool-sep"></div>
                    <button class="tool-btn" onclick="undoAction()" data-tooltip="Undo Last">‚Ü©Ô∏è</button>
                    <button class="tool-btn" onclick="clearTools()" style="color:#d32f2f;" data-tooltip="Reset All">üóëÔ∏è</button>
                    <button class="tool-btn" onclick="downloadCanvas()" data-tooltip="Save Image">üì∑</button>
                </div>
                <button class="scroll-btn-v" onclick="scrollToolbar(1)">‚ñº</button>
            </div>

            <div class="canvas-container">
                <div style="position: relative; width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
                    <canvas id="blueprintCanvas"></canvas>
                    <div id="roomListOverlay" class="active-project-chips"></div>
                </div>
            </div>
            
            <script>initCanvas("{{ image_data }}"); setTimeout(recalc, 500);</script>
            
            {% else %}
            <form id="scan-form" action="/tool" method="post" enctype="multipart/form-data" onsubmit="showLoading()" class="upload-center">
                <div class="upload-box">
                    <span class="upload-icon">üìÇ</span>
                    <div class="upload-text">Upload a blueprint to start</div>
                    <input type="file" name="file" accept="image/*,.pdf" class="center-file-input" required onchange="updateFileName(this)">
                    <button type="submit" class="center-btn">INITIATE SCAN</button>
                </div>
            </form>
            {% endif %}
        </div>

    </div>

    {% if result %}
    <div class="footer-bar">
        <div class="footer-group">
            <div style="display:flex; align-items:center; gap:5px;">
                <label style="font-size:10px; color:#4b5563; font-weight:bold;">WASTE: <span id="waste_display" style="color:#0a0e17;">0%</span></label>
                <input type="range" id="waste_slider" min="0" max="20" step="5" value="0" oninput="recalc()" style="width:80px; accent-color:#0a0e17;">
            </div>
            
            <div class="metric-mini"><label>Width (ft)</label><input type="number" id="real_width_input" class="input-mini" value="50" oninput="recalc()"></div>
            <div class="metric-mini"><label id="lbl_sheet">Sheet $</label><input type="number" id="cost_sheet" class="input-mini" value="15" oninput="recalc()"></div>
            <div class="metric-mini"><label id="lbl_paint">Paint $</label><input type="number" id="cost_paint" class="input-mini" value="40" oninput="recalc()"></div>
             
             <input type="hidden" id="cost_elec" value="5"><input type="hidden" id="cost_plumb" value="150"><input type="hidden" id="cost_hvac" value="80">
            <select id="currency_select" class="input-mini" onchange="updateCurrency(this)" style="width:70px; border-color:#0a0e17; color:#0a0e17;">
                <option value="$">USD ($)</option>
                <option value="‚Çπ">INR (‚Çπ)</option>
                <option value="‚Ç¨">EUR (‚Ç¨)</option>
                <option value="¬£">GBP (¬£)</option>
                <option value="C$">CAD</option>
                <option value="A$">AUD</option>
                <option value="¬•">JPY</option>
            </select>
        </div>
        <div class="footer-group" style="gap:20px;">
            <div class="metric-mini" style="border:none; background:transparent; text-align:left;"><label>FEET</label><div class="val" id="disp_feet">---</div></div>
            <div class="metric-mini" style="border:none; background:transparent; text-align:left;"><label>SQ.FT</label><div class="val" id="disp_area">---</div></div>
            <div class="metric-mini" style="border:none; background:transparent; text-align:left;"><label>COUNT</label><div class="val" id="disp_count">0</div></div>
            <div class="metric-mini" style="border: 2px solid #0a0e17; padding: 5px 15px;"><label style="color:#0a0e17;">ESTIMATE</label><div class="val" id="disp_cost" style="font-size:22px;">---</div></div>
        </div>
    </div>
    {% endif %}

</body>
</html>