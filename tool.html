<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapTakeoff Estimator</title>
    <link rel="icon" href="/favicon.ico">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        /* --- CORE APP LAYOUT --- */
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; font-family: 'Helvetica Neue', sans-serif; overflow: hidden; 
            display: flex; flex-direction: column; height: 100vh; background-color: #111827; 
        }

        /* 1. HEADER (Top) */
        .navbar {
            height: 50px; background-color: #0a0e17; display: flex; align-items: center;
            justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #1f2937; flex-shrink: 0; z-index: 60;
        }
        .logo { font-size: 20px; font-weight: 800; color: white; text-decoration: none; }
        .highlight { color: #FFC107; }

        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        .header-btn, .header-select {
            padding: 6px 12px; border-radius: 4px; font-weight: bold; font-size: 13px; cursor: pointer; 
            border: 1px solid rgb(59, 59, 59); background: rgb(41, 41, 41); color: #ffffff; transition: 0.2s;
        }
        .header-btn:hover, .header-select:hover {
            background: #2563eb; color: white; border-color: #2563eb;   
        }
        .header-btn.active {
            background: #2563eb; color: white; border-color: #2563eb;
        }
        .btn-dl { background: rgb(41, 41, 41); color: white; border: 1px solid rgb(59, 59, 59); transition: 0.2s; }
        .btn-dl:hover { background: #ffd900; color: rgb(0, 0, 0); border: #ffd900;}

        /* 2. TOOLBAR STRIP (Middle - Attached) */
        .toolbar-strip {
            height: 50px; 
            background-color: #d1d5db; 
            display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid #9ca3af;
            flex-shrink: 0; z-index: 50;
            padding: 0 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .toolbar-scroll-container {
            display: flex; align-items: center; gap: 5px; width: 100%; max-width: 1000px;
        }

        .toolbar-inner {
            flex: 1; overflow-x: auto; display: flex; flex-direction: row; gap: 8px; align-items: center;
            scrollbar-width: none; padding: 0 5px; white-space: nowrap; justify-content: center;
        }
        .toolbar-inner::-webkit-scrollbar { display: none; }

        .scroll-btn-h {
            background: transparent; border: none; color: #4b5563;
            cursor: pointer; font-size: 14px; width: 25px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; border-radius: 4px; flex-shrink: 0;
        }
        .scroll-btn-h:hover { background: rgba(0,0,0,0.1); color: #000; }

        /* ICON BUTTONS (Square) */
        .tool-btn {
            background: white; border: 1px solid #9ca3af; color: #0a0e17;
            width: 36px; height: 36px; border-radius: 6px; font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; position: relative; flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .tool-btn:hover { background: #f9fafb; border-color: #6b7280; }
        .tool-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        
        .tool-sep { width: 1px; height: 24px; background: #9ca3af; margin: 0 6px; flex-shrink: 0; }

        /* 3. APP BODY / WORKSPACE (Bottom) */
        .app-body { display: flex; flex: 1; overflow: hidden; position: relative; }

        .workspace-center { flex: 1; display: flex; flex-direction: column; background-color: #303030; position: relative; min-width: 0; }

        /* --- CENTER UPLOAD AREA --- */
        .upload-center {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #4b5563; 
        }
        .upload-box {
            background: white; padding: 40px; border-radius: 12px; border: 2px dashed #9ca3af;
            text-align: center; width: 400px; max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .upload-icon { font-size: 60px; margin-bottom: 20px; display: block; color: #FFC107; }
        .upload-text { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #1f2937; }
        
        .center-btn {
            background: #2563eb; color: white; border: none; padding: 12px 24px;
            border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;
            margin-top: 15px; width: 100%; transition: 0.2s;
        }
        .center-btn:hover { background: #1d4ed8; }
        .center-file-input {
            background: #f3f4f6; color: #1f2937; padding: 10px; border-radius: 6px;
            width: 100%; margin-bottom: 10px; border: 1px solid #d1d5db;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; display: flex;
            align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; width: 450px; max-width: 90%; max-height: 85vh;
            overflow-y: auto; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            padding: 30px; position: relative;
        }
        .modal-close {
            position: absolute; top: 15px; right: 20px; font-size: 24px;
            font-weight: bold; cursor: pointer; color: #6b7280;
        }
        .modal-title { 
            font-size: 20px; font-weight: 800; margin-bottom: 25px; 
            color: #1f2937; border-bottom: 2px solid #FFC107; display: inline-block; padding-bottom: 5px; 
        }
        .modal-text { font-size: 13px; color: #4b5563; line-height: 1.6; margin-bottom: 15px; }
        .modal-text b { color: #111827; }
        
        .config-row { margin-bottom: 20px; }
        .config-label { font-size: 13px; font-weight: bold; color: #374151; margin-bottom: 8px; display: block; }
        .slider-flex { display: flex; align-items: center; gap: 10px; }
        .slider-flex input[type=range] { flex-grow: 1; accent-color: #2563eb; height: 6px; }
        .slider-flex input[type=number] { 
            width: 60px; padding: 5px; text-align: center; border: 1px solid #d1d5db; 
            border-radius: 4px; font-weight: bold; font-size: 14px;
        }

        /* --- ROOM CHIPS --- */
        .active-project-chips { 
            position: absolute; top: 20px; right: 20px; bottom: auto; left: auto;
            display: flex; flex-direction: column; gap: 8px; pointer-events: none;
            align-items: flex-end; z-index: 40;
        }
        .room-chip { 
            pointer-events: auto; background: rgba(50, 205, 50, 0.95); 
            color: white; padding: 6px 12px; border-radius: 20px; 
            font-size: 12px; font-weight: bold; display: flex; 
            align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid white;
        }
        .room-chip .del-btn { cursor: pointer; font-weight: 900; font-size: 14px; opacity: 0.8; }

        .canvas-container {
            flex: 1; 
            overflow: auto; 
            display: flex; /* Keep flexbox */
            /* REMOVE align-items/justify-content center from here if they exist */
            background: transparent; 
            padding: 10px; 
            position: relative;
        }

        canvas { 
            box-shadow: 0 5px 25px rgba(0,0,0,0.2); background: white; 
            max-width: 100%; max-height: 100%; object-fit: contain;
        }

        /* FOOTER */
        
        .input-mini {
            background: #f9fafb; border: 1px solid #9ca3af; color: #0a0e17;
            width: 60px; padding: 4px; text-align: center; font-size: 13px; font-weight: bold; border-radius: 4px;
        }

        .hidden { display: none !important; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 23, 0.95);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #FFC107;
        }
        .spinner {
            border: 6px solid #30363d; border-top: 6px solid #FFC107; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* --- 3. APP BODY (Sidebars + Workspace) --- */
        .app-body { 
            display: flex; flex-direction: row; /* Horizontal Layout */
            flex: 1; overflow: hidden; position: relative; 
            height: calc(100vh - 100px);
        }

        /* SIDEBAR STYLES (Light Mode) */
        .sidebar {
            width: 280px; /* Fixed width */
            background-color: #ffffff; /* White background */
            border-right: 1px solid #e5e7eb; /* Light gray border */
            border-left: 1px solid #e5e7eb;
            display: flex; flex-direction: column;
            padding: 20px;
            overflow-y: auto; /* Vertical Scroll if needed */
            flex-shrink: 0;
            gap: 20px;
            z-index: 20;
        }
        .sidebar-right { border-left: 1px solid #e5e7eb; border-right: none; }

        /* Panels inside Sidebar */
        .panel-group {
            background: #dddddd; /* Very light gray box */
            border: 1px solid #929292;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .panel-title {
            font-size: 11px; font-weight: 800; color: #000000; text-transform: uppercase;
            margin-bottom: 10px; display: block; letter-spacing: 0.5px;
        }

        /* Inputs in Sidebar */
        .input-row { margin-bottom: 12px; }
        .input-row label { display: block; font-size: 12px; margin-bottom: 5px; color: #374151; font-weight: 600; }
        .sidebar-input {
            width: 100%; background: #ffffff; border: 1px solid #d1d5db; color: #111827;
            padding: 8px; border-radius: 4px; font-weight: bold; font-family: monospace; font-size: 14px;
        }
        .sidebar-input:focus { outline: none; border-color: #2563eb; ring: 2px solid #bfdbfe; }

        /* Result Display Boxes (Right Panel) */
        .result-box {
            background: #ffffff; border: 1px solid #e5e7eb; border-radius: 6px; 
            padding: 10px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .result-label { font-size: 11px; font-weight: bold; color: #6b7280; }
        .result-val { font-size: 16px; font-weight: 900; color: #111827; font-family: monospace; }
    </style>
    
    <script>
        function syncInputs(sourceId, targetId) { document.getElementById(targetId).value = document.getElementById(sourceId).value; }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function updateSens(source) {
            const slider = document.getElementById('ui_sens_slider'); const num = document.getElementById('ui_sens_num'); const hidden = document.getElementById('real_thresh');
            let val = 0; if(source === 'slider') { val = parseInt(slider.value); num.value = val; } else { val = parseInt(num.value); slider.value = val; }
            const inverted = Math.floor(200 - (val * 1.8)); hidden.value = inverted;
        }
        function initSens(serverThresh) {
            const sens = Math.round((200 - serverThresh) / 1.8); document.getElementById('ui_sens_slider').value = sens;
            document.getElementById('ui_sens_num').value = sens; document.getElementById('real_thresh').value = serverThresh;
        }
        
        // --- HORIZONTAL SCROLL FUNCTION ---
        function scrollToolbar(direction) { document.getElementById('toolbarContent').scrollBy({ left: direction * 100, behavior: 'smooth' }); }
        
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function checkFreeTrial() { if (localStorage.getItem('snaptakeoff_trial_used')) { const btn = document.getElementById('btn-free-trial'); if(btn) btn.classList.add('hidden'); } }
        
        // 1. Opens the warning window
        function useFreeTrial() {
            openModal('trialModal');
        }

        // 2. Actually executes the download (attached to the "Confirm" button)
        function confirmFreeTrial() {
            closeModal('trialModal');
            localStorage.setItem('snaptakeoff_trial_used', 'true');
            
            // Hide the button immediately so they can't click it again
            const btn = document.getElementById('btn-free-trial');
            if(btn) btn.classList.add('hidden');

            document.getElementById('download_form').submit();
        }

        function startPayment() { var options = { "key": "rzp_test_YOUR_KEY_HERE", "amount": "19900", "currency": "INR", "name": "SnapTakeoff Pro", "description": "Unlock Excel Estimate", "image": "/favicon.ico", "theme": { "color": "#FFC107" }, "handler": function (response){ document.getElementById('download_form').submit(); } }; var rzp1 = new Razorpay(options); rzp1.open(); return false; }

        let areaPoints = []; let savedAreas = []; let countPoints = []; let scalePoints = []; let measurePoints = [];
        let mode = 'none'; let currentCategory = 'elec'; let isLoupeEnabled = false; 
        let canvas, ctx, bgImage; let mouseX = 0, mouseY = 0;
        let currentZoom = 1.0; let isPanning = false; let startPanX = 0, startPanY = 0;
        let savedCutouts = []; // Stores the cutouts
        let cutoutPoints = []; // Stores the active points while drawing

        function initCanvas(imgDataStr) {
            canvas = document.getElementById('blueprintCanvas'); ctx = canvas.getContext('2d');
            bgImage = new Image();
            bgImage.onload = function() { canvas.width = bgImage.width; canvas.height = bgImage.height; redrawCanvas(); setZoom('fit'); 
            initTooltips(); // Initialize tooltips
            };
            bgImage.src = "data:image/jpeg;base64," + imgDataStr;

            canvas.addEventListener('mousemove', function(e) {
                if(mode === 'pan' && isPanning) { const container = document.querySelector('.canvas-container'); container.scrollLeft = startPanX - e.clientX; container.scrollTop = startPanY - e.clientY; return; }
                const rect = canvas.getBoundingClientRect(); const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
                mouseX = (e.clientX - rect.left) * scaleX; mouseY = (e.clientY - rect.top) * scaleY; redrawCanvas();
            });
            canvas.addEventListener('mousedown', function(e) {
                if (mode === 'pan') { isPanning = true; const container = document.querySelector('.canvas-container'); startPanX = container.scrollLeft + e.clientX; startPanY = container.scrollTop + e.clientY; canvas.style.cursor = 'grabbing'; return; }
                if (mode === 'none') return;
                const rect = canvas.getBoundingClientRect(); const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX; const y = (e.clientY - rect.top) * scaleY;
                if (mode === 'area') { areaPoints.push({x, y}); recalc(); } 
                else if (mode === 'count') { countPoints.push({x, y, type: currentCategory}); updateCountDisplay(); recalc(); } 
                else if (mode === 'scale') { scalePoints.push({x, y}); if (scalePoints.length === 2) { redrawCanvas(); setTimeout(finalizeScale, 50); } } 
                else if (mode === 'measure') { measurePoints.push({x, y}); redrawCanvas(); }
                else if (mode === 'cutout') {
                    cutoutPoints.push({x, y});
                    // If we have 2 points, we have a line! Save it.
                    if (cutoutPoints.length === 2) {
                        savedCutouts.push([...cutoutPoints]); // Save the line
                        cutoutPoints = []; // Reset for next one
                        recalc(); 
                    }
                }
                redrawCanvas();
            });
            canvas.addEventListener('mouseup', function() { if (mode === 'pan') { isPanning = false; canvas.style.cursor = 'grab'; } });
            canvas.addEventListener('mouseleave', function() { isPanning = false; });

            // --- UPDATED: CAD-STYLE MOUSE ZOOM ---
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();

                const container = document.querySelector('.canvas-container');
                const rect = container.getBoundingClientRect();

                // 1. Get mouse position relative to the viewport (the visible box)
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // 2. Get the "absolute" point on the blueprint under the mouse
                //    (Current Scroll + Mouse Offset)
                const contentX = container.scrollLeft + mouseX;
                const contentY = container.scrollTop + mouseY;

                // 3. Determine New Zoom Level
                const zoomIntensity = 0.1;
                let newZoom = currentZoom;

                if (e.deltaY < 0) {
                    newZoom += zoomIntensity; // Scroll Up -> Zoom In
                } else {
                    newZoom -= zoomIntensity; // Scroll Down -> Zoom Out
                }

                // Safety Limits
                if (newZoom < 0.1) newZoom = 0.1;
                if (newZoom > 5.0) newZoom = 5.0;

                // 4. Calculate the Scale Factor (How much are we growing/shrinking?)
                //    This is crucial: NewZoom / OldZoom tells us the % change
                const scaleFactor = newZoom / currentZoom;

                // 5. Update the Canvas Size
                currentZoom = newZoom;
                const newWidth = canvas.width * currentZoom;
                
                canvas.style.maxWidth = 'none';
                canvas.style.maxHeight = 'none';
                canvas.style.width = newWidth + 'px';
                canvas.style.height = 'auto'; // Aspect ratio handles Y scaling automatically

                // 6. CORRECT THE SCROLL POSITION
                //    Formula: (Old Absolute Point * Scale Factor) - Mouse Offset
                container.scrollLeft = (contentX * scaleFactor) - mouseX;
                container.scrollTop = (contentY * scaleFactor) - mouseY;

            }, { passive: false });
        }

        // --- JS TOOLTIPS (FLOATING) ---
        function initTooltips() {
            const tooltip = document.createElement('div');
            tooltip.style.cssText = "position:fixed; background:#0a0e17; color:white; padding:6px 10px; border-radius:4px; font-size:12px; font-weight:bold; pointer-events:none; display:none; z-index:9999; box-shadow:2px 2px 5px rgba(0,0,0,0.2); white-space:nowrap;";
            document.body.appendChild(tooltip);
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    const text = btn.getAttribute('data-tooltip');
                    if(text) {
                        tooltip.innerText = text; tooltip.style.display = 'block';
                        const rect = btn.getBoundingClientRect();
                        // Position BELOW the button
                        tooltip.style.left = (rect.left + (rect.width/2) - (tooltip.offsetWidth/2)) + 'px'; 
                        tooltip.style.top = (rect.bottom + 8) + 'px';
                    }
                });
                btn.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });
            });
        }

        function toggleLoupe() {
            isLoupeEnabled = !isLoupeEnabled;
            const btn = document.getElementById('btnLoupeToggle');
            if(isLoupeEnabled) btn.classList.add('active');
            else btn.classList.remove('active');
            redrawCanvas();
        }

        // --- CURRENCY CONVERTER LOGIC ---
        let currentRate = 1.0; 
        const rates = {
            '$': 1.0,
            '‚Çπ': 86.0,
            '‚Ç¨': 0.92,
            '¬£': 0.78,
            'C$': 1.35,
            'A$': 1.50,
            '¬•': 145.0
        };

        function updateCurrency(select) {
            const newSymbol = select.value;
            const newRate = rates[newSymbol] || 1.0;
            const ratio = newRate / currentRate;
            
            const ids = ['cost_sheet', 'cost_paint', 'cost_elec', 'cost_plumb', 'cost_hvac'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                const oldVal = parseFloat(el.value) || 0;
                let newVal = oldVal * ratio;
                if(newRate > 50) newVal = Math.round(newVal); 
                else newVal = parseFloat(newVal.toFixed(2));
                el.value = newVal;
            });

            currentRate = newRate;
            recalc();
        }

        // --- SAVE & LOAD ---
        function saveProject() {
            if(!bgImage) return alert("No blueprint to save!");
            const projectData = {
                imageData: bgImage.src,
                savedAreas: savedAreas,
                countPoints: countPoints,
                scalePoints: scalePoints,
                rawWidthStore: document.getElementById('raw_width_store').value,
                realWidth: document.getElementById('real_width_input').value,
                costSheet: document.getElementById('cost_sheet').value,
                costPaint: document.getElementById('cost_paint').value,
                currency: document.getElementById('currency_select').value
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "snaptakeoff_project.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadProject(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    bgImage = new Image();
                    bgImage.onload = function() {
                        canvas.width = bgImage.width;
                        canvas.height = bgImage.height;
                        
                        savedAreas = data.savedAreas || [];
                        countPoints = data.countPoints || [];
                        scalePoints = data.scalePoints || [];
                        
                        document.getElementById('raw_width_store').value = data.rawWidthStore || 1;
                        document.getElementById('real_width_input').value = data.realWidth || 50;
                        document.getElementById('cost_sheet').value = data.costSheet || 15;
                        document.getElementById('cost_paint').value = data.costPaint || 40;
                        document.getElementById('currency_select').value = data.currency || '$';
                        
                        // Update currentRate based on loaded currency
                        currentRate = rates[data.currency] || 1.0;

                        renderRoomList();
                        recalc();
                        redrawCanvas();
                        setZoom('fit');
                        alert("Project loaded successfully!");
                    };
                    bgImage.src = data.imageData;
                } catch(err) { alert("Error loading project file."); }
            };
            reader.readAsText(file);
        }

        function setZoom(val) {
            if(!canvas) return;
            if(val === 'fit') { 
                canvas.style.maxWidth = '100%'; 
                canvas.style.maxHeight = '100%'; 
                canvas.style.width = 'auto'; 
                canvas.style.height = 'auto';
                currentZoom = 1.0; // Reset tracking variable
            } else { 
                const scale = parseFloat(val);
                currentZoom = scale; // SYNC GLOBAL VARIABLE
                
                const newWidth = canvas.width * scale; 
                canvas.style.maxWidth = 'none'; 
                canvas.style.maxHeight = 'none'; 
                canvas.style.width = newWidth + 'px'; 
                canvas.style.height = 'auto'; 
            }
        }

        function setMode(newMode) {
            mode = (mode === newMode) ? 'none' : newMode; 
            if (mode !== 'scale') scalePoints = [];
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('catSelector').classList.add('hidden'); document.getElementById('btnSaveArea').classList.add('hidden'); 
            
            if (mode === 'none') canvas.style.cursor = 'default'; else canvas.style.cursor = 'crosshair';
            
            if (mode === 'area') { document.getElementById('btnAreaMode').classList.add('active'); document.getElementById('btnSaveArea').classList.remove('hidden'); }
            if (mode === 'count') { document.getElementById('btnCountMode').classList.add('active'); document.getElementById('catSelector').classList.remove('hidden'); }
            if (mode === 'scale') document.getElementById('btnScaleMode').classList.add('active');
            if (mode === 'measure') document.getElementById('btnMeasureMode').classList.add('active');
            if (mode === 'pan') { document.getElementById('btnPanMode').classList.add('active'); canvas.style.cursor = 'grab'; }
            redrawCanvas();
            if (mode === 'cutout') document.getElementById('btnCutoutMode').classList.add('active');
            // Also ensure `cutoutPoints = []` when switching modes
            if (mode !== 'cutout') cutoutPoints = [];
        }

        function finalizeScale() {
            let ft = prompt("Enter real-world length (Feet):", "3.0");
            if (ft && !isNaN(ft) && parseFloat(ft) > 0) {
                let p1 = scalePoints[0], p2 = scalePoints[1];
                let distPx = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
                let pxPerFt = distPx / parseFloat(ft);
                let rawWidth = parseFloat(document.getElementById('raw_width_store').value);
                document.getElementById('real_width_input').value = (rawWidth / pxPerFt).toFixed(2);
                alert("Scale Calibrated!"); recalc(); 
            }
            scalePoints = []; setMode('none'); redrawCanvas();
        }
        function saveCurrentArea() {
            if(areaPoints.length < 3) return alert("Draw area first.");
            let name = prompt("Area Name:", "Room " + (savedAreas.length + 1));
            if(name) { savedAreas.push({ name: name, points: [...areaPoints] }); areaPoints = []; renderRoomList(); recalc(); redrawCanvas(); }
        }
        function undoAction() {
            if (mode === 'area' && areaPoints.length > 0) { areaPoints.pop(); calcArea(); } 
            else if (mode === 'count' && countPoints.length > 0) { countPoints.pop(); updateCountDisplay(); recalc(); } 
            else if (mode === 'measure' && measurePoints.length > 0) { measurePoints.pop(); } 
            else if (mode === 'cutout' && savedCutouts.length > 0) { savedCutouts.pop(); recalc(); }
            redrawCanvas();
        }
        function clearTools() { if(confirm("Clear All?")) { areaPoints=[]; savedAreas=[]; countPoints=[]; scalePoints=[]; measurePoints=[]; setMode('none'); renderRoomList(); redrawCanvas(); recalc(); } }
        function downloadCanvas() { var link = document.createElement('a'); link.download = 'SnapTakeoff.png'; link.href = canvas.toDataURL("image/png"); link.click(); }
        function renderRoomList() {
            const container = document.getElementById('roomListOverlay'); container.innerHTML = "";
            savedAreas.forEach((room, index) => {
                const chip = document.createElement('div'); chip.className = 'room-chip';
                chip.innerHTML = `<span>${room.name}</span> <span class="del-btn" onclick="deleteRoom(${index})">√ó</span>`;
                container.appendChild(chip);
            });
        }
        function deleteRoom(i) { savedAreas.splice(i, 1); renderRoomList(); recalc(); redrawCanvas(); }

        function redrawCanvas() {
            if(!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(bgImage, 0, 0);

            for(let room of savedAreas) {
                if(room.points.length > 0) {
                    ctx.beginPath(); ctx.moveTo(room.points[0].x, room.points[0].y);
                    for(let i=1; i<room.points.length; i++) ctx.lineTo(room.points[i].x, room.points[i].y);
                    ctx.closePath(); ctx.fillStyle = "rgba(50, 205, 50, 0.4)"; ctx.fill();
                    ctx.lineWidth = 2; ctx.strokeStyle = "#32CD32"; ctx.stroke();
                    let cx=0, cy=0; room.points.forEach(p=>{cx+=p.x; cy+=p.y;}); cx/=room.points.length; cy/=room.points.length;
                    ctx.fillStyle = "white"; ctx.font = "bold 20px Arial"; ctx.strokeStyle="black"; ctx.lineWidth=3;
                    ctx.strokeText(room.name, cx-20, cy); ctx.fillText(room.name, cx-20, cy);
                }
            }
            if (areaPoints.length > 0) {
                ctx.beginPath(); ctx.moveTo(areaPoints[0].x, areaPoints[0].y);
                for (let i=1; i<areaPoints.length; i++) ctx.lineTo(areaPoints[i].x, areaPoints[i].y);
                ctx.closePath(); ctx.fillStyle = "rgba(255, 193, 7, 0.3)"; ctx.fill();
                ctx.lineWidth = 4; ctx.strokeStyle = "#FFC107"; ctx.stroke();
                ctx.fillStyle = "red"; areaPoints.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill(); });
            }
            ctx.lineWidth = 2; ctx.strokeStyle = "white";
            countPoints.forEach(p => {
                ctx.beginPath(); ctx.fillStyle = p.type === 'elec' ? "#00FFFF" : (p.type === 'plumb' ? "#FF4500" : "#32CD32");
                ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            });
            if(scalePoints.length > 0) {
                ctx.strokeStyle = "#FF00FF"; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(scalePoints[0].x, scalePoints[0].y);
                if(scalePoints[1]) ctx.lineTo(scalePoints[1].x, scalePoints[1].y); ctx.stroke();
            }
            const rawWidth = parseFloat(document.getElementById('raw_width_store').value || 1);
            let realFt = parseFloat(document.getElementById('real_width_input').value || 1);
            const scale = rawWidth / realFt;
            for (let i=0; i<measurePoints.length; i+=2) {
                if (i+1 < measurePoints.length) {
                    let p1 = measurePoints[i], p2 = measurePoints[i+1];
                    ctx.strokeStyle = "#FFA500"; ctx.lineWidth = 3; ctx.setLineDash([10, 5]);
                    ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); ctx.setLineDash([]);
                    let dist = (Math.sqrt(Math.pow(p2.x-p1.x, 2) + Math.pow(p2.y-p1.y, 2)) / scale).toFixed(2) + " ft";
                    let mx = (p1.x+p2.x)/2, my = (p1.y+p2.y)/2;
                    ctx.fillStyle="black"; ctx.fillRect(mx-110, my-30, 220, 60);
                    ctx.fillStyle="#FFA500"; ctx.font="bold 40px monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(dist, mx, my);
                } else {
                    ctx.fillStyle = "#FFA500"; ctx.beginPath(); ctx.arc(measurePoints[i].x, measurePoints[i].y, 5, 0, Math.PI*2); ctx.fill();
                }
            }
            // Draw Saved Cutouts
            ctx.lineWidth = 3;
            ctx.strokeStyle = "#FF0000"; // Red color
            for(let line of savedCutouts) {
                ctx.beginPath();
                ctx.moveTo(line[0].x, line[0].y);
                ctx.lineTo(line[1].x, line[1].y);
                ctx.stroke();
            }

            // Draw Active Cutout Line (while dragging)
            if (mode === 'cutout' && cutoutPoints.length === 1) {
                ctx.beginPath();
                ctx.moveTo(cutoutPoints[0].x, cutoutPoints[0].y);
                ctx.lineTo(mouseX, mouseY); // Draw to current mouse position
                ctx.strokeStyle = "#FF0000";
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            if (isLoupeEnabled && mode !== 'none' && mode !== 'pan') {
                const r = 75, zoom = 4;
                ctx.save(); ctx.beginPath(); ctx.arc(mouseX, mouseY, r, 0, Math.PI*2); ctx.clip();
                ctx.fillStyle = "white"; ctx.fillRect(mouseX-r, mouseY-r, r*2, r*2);
                ctx.drawImage(bgImage, mouseX-r/zoom, mouseY-r/zoom, (r*2)/zoom, (r*2)/zoom, mouseX-r, mouseY-r, r*2, r*2);
                ctx.strokeStyle = "#00FFFF"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(mouseX-10, mouseY); ctx.lineTo(mouseX+10, mouseY); ctx.moveTo(mouseX, mouseY-10); ctx.lineTo(mouseX, mouseY+10); ctx.stroke(); ctx.restore();
                ctx.beginPath(); ctx.arc(mouseX, mouseY, r, 0, Math.PI*2); ctx.lineWidth=3; ctx.strokeStyle="white"; ctx.stroke();
            }
        }

        function getPolyArea(points) {
            if(points.length<3) return 0; let area=0; for(let i=0; i<points.length; i++) { let j=(i+1)%points.length; area += points[i].x*points[j].y; area -= points[j].x*points[i].y; } return Math.abs(area)/2;
        }
        function updateCountDisplay() {}
        function recalc() {
            try {
                // 1. Basic Setup
                // Note: We removed the old 'disp_count' update here because we removed that box
                const rawWidth = parseFloat(document.getElementById('raw_width_store').value);
                let realFt = parseFloat(document.getElementById('real_width_input').value) || 1;
                const scale = rawWidth / realFt;

                // 2. Get Ceiling Height
                let ceilingHeight = parseFloat(document.getElementById('wall_height_input').value) || 8.0;

                let totalSqFt = 0;
                let totalWallSqFt = 0;
                let breakdown = [];

                // 3. THE LOOP
                for(let r of savedAreas) { 
                    // Floor Area
                    let ft = getPolyArea(r.points) / (scale*scale); 
                    totalSqFt += ft;

                    // Wall Area
                    let perimeterPx = getPolyPerimeter(r.points);
                    let perimeterFt = perimeterPx / scale; 
                    let wallArea = perimeterFt * ceilingHeight;
                    totalWallSqFt += wallArea;

                    breakdown.push({name: r.name, sqft: ft.toFixed(2)}); 
                }
                // ... loop finishes ...

                // --- NEW: CALCULATE CUTOUTS ---
                let cutoutHeight = parseFloat(document.getElementById('cutout_height_input').value) || 7.0;
                let totalCutoutArea = 0;

                for (let line of savedCutouts) {
                    // Calculate length of the line in pixels
                    let distPx = Math.sqrt(Math.pow(line[1].x - line[0].x, 2) + Math.pow(line[1].y - line[0].y, 2));
                    // Convert to feet
                    let distFt = distPx / scale;
                    // Area = Width * Height
                    totalCutoutArea += (distFt * cutoutHeight);
                }

                // Subtract cutout area from wall area (prevent negative numbers)
                totalWallSqFt = Math.max(0, totalWallSqFt - totalCutoutArea);
                // ------------------------------

                // 5. Update Displays
                document.getElementById('disp_wall_area').innerText = totalWallSqFt.toFixed(2);
                
                // 4. Handle Current Drawing
                if (areaPoints.length > 0) {
                    let currentFt = getPolyArea(areaPoints) / (scale*scale); 
                    totalSqFt += currentFt;
                    
                    let currentPerimPx = getPolyPerimeter(areaPoints);
                    let currentWall = (currentPerimPx / scale) * ceilingHeight;
                    totalWallSqFt += currentWall;
                }
                
                // 5. Update Displays
                document.getElementById('disp_area').innerText = totalSqFt.toFixed(2);
                document.getElementById('disp_wall_area').innerText = totalWallSqFt.toFixed(2);
                
                document.getElementById('hidden_area').value = totalSqFt.toFixed(2);
                document.getElementById('hidden_area_breakdown').value = JSON.stringify(breakdown);

                const rawPixels = parseFloat(document.getElementById('raw_pixels_store').value);
                const totalLinearFt = rawPixels / scale;
                document.getElementById('disp_feet').innerText = totalLinearFt.toFixed(2);

                let wasteVal = document.getElementById('waste_slider').value;
                let waste = 1 + (parseFloat(wasteVal)/100);
                document.getElementById('waste_display').innerText = wasteVal + "%";

                let pSheet = parseFloat(document.getElementById('cost_sheet').value) || 0;
                let pPaint = parseFloat(document.getElementById('cost_paint').value) || 0;
                
                let sheets = ((totalLinearFt * 8) / 32) * waste; 
                let paint = ((totalLinearFt * 8) / 400) * waste;
                
                let cElec = parseFloat(document.getElementById('cost_elec').value) || 0;
                let cPlumb = parseFloat(document.getElementById('cost_plumb').value) || 0;
                let cHvac = parseFloat(document.getElementById('cost_hvac').value) || 0;
                
                // --- CORRECTED COUNTING LOGIC (Only appears once now) ---
                let nElec=0, nPlumb=0, nHvac=0;
                countPoints.forEach(p => { 
                    if(p.type==='elec') nElec++; 
                    else if(p.type==='plumb') nPlumb++; 
                    else nHvac++; 
                });

                // Update Specific Displays
                const elElec = document.getElementById('disp_count_elec');
                const elPlumb = document.getElementById('disp_count_plumb');
                const elHvac = document.getElementById('disp_count_hvac');

                if(elElec) elElec.innerText = nElec;
                if(elPlumb) elPlumb.innerText = nPlumb;
                if(elHvac) elHvac.innerText = nHvac;
                // -------------------------------------

                // --- NEW FLOORING LOGIC ---
                // 1. Get flooring price per sq.ft
                let pFloor = parseFloat(document.getElementById('cost_floor').value) || 0;

                // 2. Add (totalSqFt * pFloor) to the formula
                let totalCost = (sheets*pSheet) + (paint*pPaint) + (totalSqFt * pFloor) + (nElec*cElec) + (nPlumb*cPlumb) + (nHvac*cHvac);
                
                // 3. Update the Label Text (to show current currency)
                let cur = document.getElementById('currency_select').value;
                const floorLbl = document.getElementById('lbl_floor');
                if(floorLbl) floorLbl.innerText = "Flooring Price (" + cur + "/sq.ft)";
                
                
                document.getElementById('lbl_sheet').innerText = "Sheet " + cur;
                document.getElementById('lbl_paint').innerText = "Paint " + cur;
                document.getElementById('disp_cost').innerText = cur + totalCost.toFixed(2);

                // 1. Pass Totals
                document.getElementById('hidden_feet').value = totalLinearFt.toFixed(2);
                document.getElementById('hidden_cost').value = totalCost.toFixed(2);
                document.getElementById('hidden_sheets').value = sheets.toFixed(2);
                document.getElementById('hidden_paint').value = paint.toFixed(2);
                
                // 2. Pass Counts
                document.getElementById('hidden_count_elec').value = nElec;
                document.getElementById('hidden_count_plumb').value = nPlumb;
                document.getElementById('hidden_count_hvac').value = nHvac;
                
                // 3. Pass Config/Unit Prices
                document.getElementById('hidden_currency').value = cur;
                document.getElementById('hidden_waste_percent').value = wasteVal;
                
                document.getElementById('hidden_unit_sheet').value = pSheet;
                document.getElementById('hidden_unit_paint').value = pPaint;
                document.getElementById('hidden_unit_floor').value = pFloor;
                
                // 4. Pass Item Unit Prices (New)
                document.getElementById('hidden_unit_elec').value = cElec;
                document.getElementById('hidden_unit_plumb').value = cPlumb;
                document.getElementById('hidden_unit_hvac').value = cHvac;

                checkFreeTrial();
            } catch(e) { console.log(e); }
        }
        // NEW: Calculates the perimeter of a polygon (room)
        function getPolyPerimeter(points) {
            if (points.length < 2) return 0;
            let perimeter = 0;
            for (let i = 0; i < points.length; i++) {
                let p1 = points[i];
                let p2 = points[(i + 1) % points.length]; // Wraps around to the first point to close the loop
        
                // Pythagorean theorem to find distance between p1 and p2
                let dist = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
                perimeter += dist;
            }
            return perimeter;
        }
        function toggleWastePopup() {
            const popup = document.getElementById('wastePopup');
            popup.classList.toggle('hidden');
        }
        function toggleWasteAccordion() {
            const acc = document.getElementById('wasteAccordion');
            if (acc.classList.contains('hidden')) {
                acc.classList.remove('hidden');
            } else {
                acc.classList.add('hidden');
            }
        }
    </script>
</head>
<body onload="checkFreeTrial(); {% if result %}initSens({{ params.thresh }});{% endif %}">

    <div id="configModal" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('configModal')">
        <div class="modal-box">
            <span class="modal-close" onclick="closeModal('configModal')">&times;</span>
            <div class="modal-title">Sensor Configuration</div>
            
            <div class="config-row"><label class="config-label">Sensitivity (Detection Power)</label><div class="slider-flex"><input type="range" id="ui_sens_slider" min="0" max="100" value="83" oninput="updateSens('slider')" form="scan-form"><input type="number" id="ui_sens_num" value="83" oninput="updateSens('num')" form="scan-form"><input type="hidden" id="real_thresh" name="thresh" value="50" form="scan-form"></div></div>
            <div class="config-row"><label class="config-label">Gap Fill</label><div class="slider-flex"><input type="range" id="range_gap" name="gap" min="5" max="100" value="{{ params.gap }}" oninput="syncInputs('range_gap', 'num_gap')" form="scan-form"><input type="number" id="num_gap" value="{{ params.gap }}" oninput="syncInputs('num_gap', 'range_gap')" form="scan-form"></div></div>
            <div class="config-row"><label class="config-label">Min Wall Length</label><div class="slider-flex"><input type="range" id="range_len" name="min_len" min="50" max="500" value="{{ params.min_len }}" oninput="syncInputs('range_len', 'num_len')" form="scan-form"><input type="number" id="num_len" value="{{ params.min_len }}" oninput="syncInputs('num_len', 'range_len')" form="scan-form"></div></div>
            <div class="config-row"><label class="config-label">Wall Thickness</label><div class="slider-flex"><input type="range" id="range_thick" name="thick" min="1" max="10" value="{{ params.thick }}" oninput="syncInputs('range_thick', 'num_thick')" form="scan-form"><input type="number" id="num_thick" value="{{ params.thick }}" oninput="syncInputs('num_thick', 'range_thick')" form="scan-form"></div></div>
            
            <button onclick="closeModal('configModal')" style="width:100%; padding:10px; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">Done</button>
        </div>
    </div>

    <div id="guideModal" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('guideModal')">
        <div class="modal-box">
            <span class="modal-close" onclick="closeModal('guideModal')">&times;</span>
            <div class="modal-title">Controls Guide</div>
            
            <div class="modal-text">
                <b>üìè Scale:</b> First step! Draw line over known length -> Enter feet.<br>
                <b>üìê Area:</b> Click room corners -> Click 'Save'.<br>
                <b>üëÜ Count:</b> Click items to count.<br>
                <b>‚úã Pan:</b> Drag to move blueprint.<br>
                <b>üîç Zoom:</b> Use dropdown or scroll.
            </div>

            <div style="border-top: 1px solid #e5e7eb; margin: 15px 0; padding-top: 10px;"></div>
            <div class="modal-title" style="font-size: 16px;">Slider Settings</div>
            <div class="modal-text">
                <b>Sensitivity:</b> (Detection Power)<br>
                ‚¨ÖÔ∏è <b>Left:</b> Detects only bold/dark lines.<br>
                ‚û°Ô∏è <b>Right:</b> Detects faint lines (might catch noise).<br><br>

                <b>Gap Fill:</b> (Connects broken lines)<br>
                ‚¨ÖÔ∏è <b>Left:</b> Fills tiny gaps only.<br>
                ‚û°Ô∏è <b>Right:</b> Bridges large gaps between walls.<br><br>

                <b>Min Wall Length:</b> (Filters noise)<br>
                ‚¨ÖÔ∏è <b>Left:</b> Keeps short lines/details.<br>
                ‚û°Ô∏è <b>Right:</b> Ignores short lines (cleaner).<br><br>

                <b>Waste %:</b> (Safety Margin)<br>
                ‚¨ÖÔ∏è <b>Left:</b> 0% extra material.<br>
                ‚û°Ô∏è <b>Right:</b> Adds up to 20% to cost estimate.
            </div>
        </div>
    </div>

    <div id="trialModal" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('trialModal')">
        <div class="modal-box" style="border-top: 5px solid #FFC107;">
            <span class="modal-close" onclick="closeModal('trialModal')">&times;</span>
            <div class="modal-title" style="color:#b45309;">‚ö†Ô∏è One-Time Warning</div>
            
            <div class="modal-text" style="font-size:15px;">
                You are about to use your <b>single free unlock</b>.
                <br><br>
                Once you click confirm:
                <ul style="margin-left:20px; margin-top:5px; margin-bottom:15px;">
                    <li>The Excel file will download immediately.</li>
                    <li>You <b>cannot</b> use this free trial again.</li>
                </ul>
                Please <b>recheck your measurements</b> (scale, walls, prices) before proceeding.
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="closeModal('trialModal')" style="flex:1; padding:12px; background:#e5e7eb; color:#374151; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">Go Back</button>
                <button onclick="confirmFreeTrial()" style="flex:1; padding:12px; background:#FFC107; color:#000; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">Confirm & Unlock</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div><h2 style="font-family: monospace;">PROCESSING...</h2>
    </div>

    <div class="navbar">
        <a href="/" class="logo">Snap<span class="highlight">Takeoff</span></a>
        
        {% if result %}
        <div class="header-actions">
            <select class="header-select" onchange="setZoom(this.value)" style="margin-right:10px;">
                <option value="fit">Fit to Screen</option>
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
                <option value="1.0" selected>100% (Actual)</option>
                <option value="1.5">150%</option>
                <option value="2.0">200%</option>
                <option value="3.0">300%</option>
                <option value="4.0">400%</option>
            </select>

            <button id="btnLoupeToggle" onclick="toggleLoupe()" class="header-btn">üîç Magnifier</button>

            <button onclick="openModal('configModal')" class="header-btn">üéöÔ∏è Sensor Config</button>
            <button onclick="saveProject()" class="header-btn">üíæ Save</button>
            <button onclick="document.getElementById('loadProjectInput').click()" class="header-btn">üìÇ Load</button>
            <input type="file" id="loadProjectInput" style="display:none" onchange="loadProject(this)" accept=".json">
            <button onclick="openModal('guideModal')" class="header-btn">‚ÑπÔ∏è Guide</button>

            <form id="download_form" action="/download_report" method="post" style="display:flex; gap:10px;">
                <input type="hidden" name="final_feet" id="hidden_feet">
                <input type="hidden" name="final_cost" id="hidden_cost">
                <input type="hidden" name="final_sheets" id="hidden_sheets">
                <input type="hidden" name="final_paint" id="hidden_paint">
                <input type="hidden" name="unit_price_floor" id="hidden_unit_floor">
                <input type="hidden" name="final_area" id="hidden_area">
                <input type="hidden" name="area_breakdown" id="hidden_area_breakdown">
                <input type="hidden" name="currency_symbol" id="hidden_currency">
                <input type="hidden" name="unit_price_sheet" id="hidden_unit_sheet">
                <input type="hidden" name="unit_price_paint" id="hidden_unit_paint">
                <input type="hidden" name="count_elec" id="hidden_count_elec">
                <input type="hidden" name="count_plumb" id="hidden_count_plumb">
                <input type="hidden" name="count_hvac" id="hidden_count_hvac">
                <input type="hidden" name="waste_percent" id="hidden_waste_percent">

                <input type="hidden" name="unit_elec" id="hidden_unit_elec">
                <input type="hidden" name="unit_plumb" id="hidden_unit_plumb">
                <input type="hidden" name="unit_hvac" id="hidden_unit_hvac">

                <button type="button" id="btn-free-trial" onclick="useFreeTrial()" class="header-btn">üéÅ Free Trial</button>
                <button type="button" onclick="startPayment()" class="header-btn btn-dl">üíé Download Excel (199/-)</button>
            </form>
        </div>
        {% endif %}
    </div>

    {% if result %}
    <div class="toolbar-strip">
        <div class="toolbar-scroll-container">
            <button class="scroll-btn-h" onclick="scrollToolbar(-1)">‚óÄ</button>
            <div class="toolbar-inner" id="toolbarContent">
                <button class="tool-btn" id="btnScaleMode" onclick="setMode('scale')" data-tooltip="Calibrate Scale">üìè</button>
                <div class="tool-sep"></div>
                <button class="tool-btn" id="btnAreaMode" onclick="setMode('area')" data-tooltip="Measure Area">üìê</button>
                <button class="tool-btn hidden" id="btnSaveArea" onclick="saveCurrentArea()" style="color:#2ea043; font-weight:900;" data-tooltip="Save Area">üíæ</button>
                <button class="tool-btn" id="btnCutoutMode" onclick="setMode('cutout')" data-tooltip="Cutout (Draw Width)">‚úÇÔ∏è</button>
                <div class="tool-sep"></div>
                <button class="tool-btn" id="btnCountMode" onclick="setMode('count')" data-tooltip="Count Items">üëÜ</button>
                <select id="catSelector" class="hidden" onchange="currentCategory=this.value" style="font-size:11px; width:auto; padding: 0 5px;">
                    <option value="elec">‚ö° Electrical</option>
                    <option value="plumb">üöø Plumbing</option>
                    <option value="hvac">‚ùÑÔ∏è HVAC</option>
                </select>
                <div class="tool-sep"></div>
                <button class="tool-btn" id="btnMeasureMode" onclick="setMode('measure')" data-tooltip="Tape Measure">üìè</button>
                <button class="tool-btn" id="btnPanMode" onclick="setMode('pan')" data-tooltip="Pan View">‚úã</button>
                <div class="tool-sep"></div>
                <button class="tool-btn" onclick="undoAction()" data-tooltip="Undo Last">‚Ü©Ô∏è</button>
                <button class="tool-btn" onclick="clearTools()" style="color:#d32f2f;" data-tooltip="Reset All">üóëÔ∏è</button>
                <button class="tool-btn" onclick="downloadCanvas()" data-tooltip="Save Image">üì∑</button>
            </div>
            <button class="scroll-btn-h" onclick="scrollToolbar(1)">‚ñ∂</button>
        </div>
    </div>
    {% endif %}

    <div class="app-body">
        
        {% if result %}
        <div class="sidebar">
            <div class="panel-group">
                <span class="panel-title">üßä Dimensions</span>
                <div class="input-row">
                    <label>Blueprint Width (ft)</label>
                    <input type="number" id="real_width_input" class="sidebar-input" value="50" oninput="recalc()">
                </div>
                <div class="input-row">
                    <label>Wall Height (ft)</label>
                    <input type="number" id="wall_height_input" class="sidebar-input" value="8" oninput="recalc()">
                </div>
                <div class="input-row">
                    <label>Cutout Height (ft)</label>
                    <input type="number" id="cutout_height_input" class="sidebar-input" value="7" oninput="recalc()">
                </div>
            </div>

            <div class="panel-group">
                <span class="panel-title">üí∞ Material Costs</span>
                <div class="input-row">
                    <label id="lbl_sheet">Sheet Price ($)</label>
                    <input type="number" id="cost_sheet" class="sidebar-input" value="15" oninput="recalc()">
                </div>
                <div class="input-row">
                    <label id="lbl_paint">Paint Price ($)</label>
                    <input type="number" id="cost_paint" class="sidebar-input" value="40" oninput="recalc()">
                </div>
                <div class="input-row">
                    <label id="lbl_floor">Flooring Price ($/sq.ft)</label>
                    <input type="number" id="cost_floor" class="sidebar-input" value="5" oninput="recalc()">
                </div>
                <input type="hidden" id="cost_elec" value="5">
                <input type="hidden" id="cost_plumb" value="150">
                <input type="hidden" id="cost_hvac" value="80">
            </div>

            <div class="panel-group">
                <span class="panel-title">üõ†Ô∏è Settings</span>
                
                <button onclick="toggleWasteAccordion()" style="width:100%; padding:8px; background:#ffffff; border:1px solid #b3b3b3; border-radius:4px; cursor:pointer; font-weight:bold; color:#374151; display:flex; justify-content:space-between; margin-bottom:10px;">
                    Waste % <span id="waste_display">0%</span>
                </button>
                <div id="wasteAccordion" class="hidden" style="padding:10px; background:#ffffff; margin-bottom:10px; border-radius: 4px; border:1px solid #b3b3b3;">
                    <input type="range" id="waste_slider" min="0" max="20" step="5" value="0" oninput="recalc()" style="width:100%; accent-color:#2563eb;">
                </div>

                <div class="input-row">
                    <label>Currency</label>
                    <select id="currency_select" class="sidebar-input" onchange="updateCurrency(this)">
                        <option value="$">USD ($)</option>
                        <option value="‚Çπ">INR (‚Çπ)</option>
                        <option value="‚Ç¨">EUR (‚Ç¨)</option>
                        <option value="¬£">GBP (¬£)</option>
                        <option value="C$">CAD</option>
                        <option value="A$">AUD</option>
                        <option value="¬•">JPY</option>
                    </select>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="workspace-center">
            {% if result %}
                <input type="hidden" id="raw_pixels_store" value="{{ raw_pixels }}">
                <input type="hidden" id="raw_width_store" value="{{ raw_width }}">

                <div class="canvas-container">
                    <div style="position: relative; margin: auto; flex-shrink: 0;">
                        <canvas id="blueprintCanvas"></canvas>
                        <div id="roomListOverlay" class="active-project-chips"></div>
                    </div>
                </div>
                
                <script>initCanvas("{{ image_data }}"); setTimeout(recalc, 500);</script>
            
            {% else %}
                <form id="scan-form" action="/tool" method="post" enctype="multipart/form-data" onsubmit="showLoading()" class="upload-center">
                    <div class="upload-box">
                        <span class="upload-icon">üìÇ</span>
                        <div class="upload-text">Upload a blueprint to start</div>
                        <input type="file" name="file" accept="image/*,.pdf" class="center-file-input" required onchange="updateFileName(this)">
                        <button type="submit" class="center-btn">INITIATE SCAN</button>
                    </div>
                </form>
            {% endif %}
        </div>

        {% if result %}
        <div class="sidebar sidebar-right">
            <div class="panel-group">
                <span class="panel-title">Measurements</span>
                <div class="result-box">
                    <span class="result-label">WALL SQ.FT</span>
                    <span class="result-val" id="disp_wall_area">---</span>
                </div>
                <div class="result-box">
                    <span class="result-label">FLOOR SQ.FT</span>
                    <span class="result-val" id="disp_area">---</span>
                </div>
                <div class="result-box">
                    <span class="result-label">LINEAR FEET</span>
                    <span class="result-val" id="disp_feet">---</span>
                </div>
            </div>

            <div class="panel-group">
                <span class="panel-title">Item Counts</span>
                <div class="result-box" style="border-left: 4px solid #00FFFF;">
                    <span class="result-label" style="color:#008B8B;">ELEC ‚ö°</span>
                    <span class="result-val" id="disp_count_elec">0</span>
                </div>
                <div class="result-box" style="border-left: 4px solid #FF4500;">
                    <span class="result-label" style="color:#A02C00;">PLUMB üöø</span>
                    <span class="result-val" id="disp_count_plumb">0</span>
                </div>
                <div class="result-box" style="border-left: 4px solid #32CD32;">
                    <span class="result-label" style="color:#1E7E1E;">HVAC ‚ùÑÔ∏è</span>
                    <span class="result-val" id="disp_count_hvac">0</span>
                </div>
            </div>

            <div class="panel-group" style="border-color: #2563eb; background:#eff6ff;">
                <span class="panel-title" style="color:#2563eb;">Total Estimate</span>
                <div style="text-align:center; padding:10px;">
                    <span id="disp_cost" style="font-size:28px; font-weight:900; color:#2563eb; display:block;">---</span>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</body>
</html>