<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapTakeoff Prime</title>
    <link rel="icon" href="/favicon.ico">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        /* CORE STYLES - CLEAN & STATIC */
        body { background-color: #e8eaf6; font-family: 'Helvetica Neue', sans-serif; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 300px; background-color: #0a0e17; color: #c9d1d9; padding: 30px; display: flex; flex-direction: column; border-right: 1px solid #1f2937; }
        .logo { font-size: 32px; font-weight: 800; color: white; margin-bottom: 5px; line-height: 1; }
        .highlight { color: #FFD700; }
        .sub-logo { font-size: 12px; color: #8b949e; margin-bottom: 50px; letter-spacing: 1px; }
        
        .menu-item { padding: 15px 0; border-bottom: 1px solid #21262d; cursor: pointer; font-size: 16px; font-weight: 500; text-decoration: none; color: #c9d1d9; display: block; }
        .menu-item:hover { color: #FFD700; padding-left: 10px; }
        .active { color: white; border-right: 3px solid #00d26a; }

        .main-content { flex-grow: 1; padding: 60px; overflow-y: auto; }
        .box { background-color: #161b22; border: 1px solid #00d26a; box-shadow: 0 0 20px rgba(0, 210, 106, 0.2); border-radius: 12px; padding: 40px; color: white; max-width: 800px; margin-bottom: 30px; }
        
        h1 { color: #0a0e17; margin-top: 0; font-size: 3rem; }
        h2 { color: #00d26a; font-family: 'Courier New', monospace; margin-top: 0; }
        
        .slider-row { display: flex; align-items: center; gap: 15px; }
        .slider-container { flex-grow: 1; margin-bottom: 15px; }
        .slider-label { display: block; font-size: 14px; color: #8b949e; margin-bottom: 5px; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #00d26a; }
        input[type=number] { background-color: #0d1117; border: 1px solid #30363d; color: #00d26a; padding: 5px; border-radius: 5px; font-family: monospace; font-weight: bold; text-align: center; }
        
        .btn-upload { background-color: #21262d; color: #00d26a; border: 1px solid #30363d; padding: 12px 24px; border-radius: 6px; font-weight: bold; font-size: 16px; cursor: pointer; width: 100%; margin-top: 20px;}
        .btn-upload:hover { border-color: #00d26a; color: white; }

        .results-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
        .metric-box { background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; text-align: center; margin-bottom: 10px; }
        .metric-val { font-size: 24px; color: #00d26a; font-family: monospace; font-weight: bold; }
        .metric-label { font-size: 12px; color: #8b949e; margin-top: 5px; }
        .calib-input { width: 80px; font-size: 18px; padding: 8px; border-color: #FFD700; color: #FFD700; }

        /* PAY BUTTON STYLE */
        .btn-pay {
            background-color: #FFD700; color: #0a0e17; border: none; padding: 15px;
            width: 100%; border-radius: 8px; font-weight: 800; cursor: pointer; margin-top: 20px;
            font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-pay:hover { background-color: #e6c200; }
    </style>
    
    <script>
        function syncInputs(sourceId, targetId) { document.getElementById(targetId).value = document.getElementById(sourceId).value; }
        
        // --- PAYMENT LOGIC (PAY PER USE) ---
        function startPayment() {
            var options = {
                // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL RAZORPAY KEY ID
                "key": "rzp_test_YOUR_KEY_HERE", 
                
                "amount": "19900", // 19900 paise = ‚Çπ199
                "currency": "INR",
                "name": "SnapTakeoff Pro",
                "description": "Unlock Excel Estimate",
                "image": "/favicon.ico",
                "handler": function (response){
                    // Payment Success: Submit the form to download
                    document.getElementById('download_form').submit();
                },
                "theme": { "color": "#FFD700" }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
            return false; // Prevent form from submitting before payment
        }

        function recalc() {
            try {
                const rawPixels = parseFloat(document.getElementById('raw_pixels_store').value);
                const rawWidth = parseFloat(document.getElementById('raw_width_store').value);
                let realFt = parseFloat(document.getElementById('real_width_input').value);
                if (!realFt || realFt <= 0) realFt = 1;
                const scale = rawWidth / realFt; 
                const totalFeet = rawPixels / scale;
                const sheets = (totalFeet * 8) / 32;
                const costDrywall = sheets * 15;
                const paint = (totalFeet * 8) / 400;
                const costPaint = paint * 40;
                const totalCost = costDrywall + costPaint;
                
                document.getElementById('display_feet').innerText = totalFeet.toFixed(2) + " ft";
                document.getElementById('display_cost').innerText = "$" + totalCost.toFixed(2);
                
                // Update hidden inputs for the download logic
                document.getElementById('hidden_feet').value = totalFeet.toFixed(2);
                document.getElementById('hidden_cost').value = totalCost.toFixed(2);
                document.getElementById('hidden_sheets').value = sheets;
                document.getElementById('hidden_paint').value = paint;
            } catch(e) {}
        }
    </script>
</head>
<body>

    <div class="sidebar">
        <div class="logo">Snap<span class="highlight">Takeoff</span></div>
        <div class="sub-logo">AI ESTIMATOR PROTOCOL</div>
        <a href="/" class="menu-item {% if page == 'home' %}active{% endif %}">Home</a>
        <a href="/tool" class="menu-item {% if page == 'tool' %}active{% endif %}">Upload Blueprint</a>
    </div>

    <div class="main-content">
        {% if page == 'home' %}
            <h1>Welcome.</h1>
            <div class="box" style="border-color: #30363d; box-shadow: none;">
                <h2>// SYSTEM OVERVIEW</h2>
                <p style="color: #c9d1d9;">Navigate to <strong>Upload Blueprint</strong> to begin.</p>
            </div>
        {% endif %}

        {% if page == 'tool' %}
            <h1>Upload Blueprint.</h1>
            <div class="box">
                <h2>// SENSOR CONFIGURATION</h2>
                <form action="/tool" method="post" enctype="multipart/form-data">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <div class="slider-container"><label class="slider-label">Sensitivity</label><div class="slider-row"><input type="range" id="range_thresh" name="thresh" min="20" max="200" value="{{ params.thresh }}" oninput="syncInputs('range_thresh', 'num_thresh')"><input type="number" id="num_thresh" min="20" max="200" value="{{ params.thresh }}" oninput="syncInputs('num_thresh', 'range_thresh')"></div></div>
                            <div class="slider-container"><label class="slider-label">Min Wall Length</label><div class="slider-row"><input type="range" id="range_len" name="min_len" min="50" max="500" value="{{ params.min_len }}" oninput="syncInputs('range_len', 'num_len')"><input type="number" id="num_len" min="50" max="500" value="{{ params.min_len }}" oninput="syncInputs('num_len', 'range_len')"></div></div>
                        </div>
                        <div>
                            <div class="slider-container"><label class="slider-label">Gap Fill</label><div class="slider-row"><input type="range" id="range_gap" name="gap" min="5" max="100" value="{{ params.gap }}" oninput="syncInputs('range_gap', 'num_gap')"><input type="number" id="num_gap" min="5" max="100" value="{{ params.gap }}" oninput="syncInputs('num_gap', 'range_gap')"></div></div>
                            <div class="slider-container"><label class="slider-label">Wall Thickness</label><div class="slider-row"><input type="range" id="range_thick" name="thick" min="1" max="10" value="{{ params.thick }}" oninput="syncInputs('range_thick', 'num_thick')"><input type="number" id="num_thick" min="1" max="10" value="{{ params.thick }}" oninput="syncInputs('num_thick', 'range_thick')"></div></div>
                        </div>
                    </div>
                    <hr style="border-color: #30363d; margin: 20px 0;">
                    <input type="file" name="file" required style="color: #c9d1d9;">
                    <button type="submit" class="btn-upload">INITIATE SCAN</button>
                </form>
            </div>

            {% if result %}
            <input type="hidden" id="raw_pixels_store" value="{{ raw_pixels }}">
            <input type="hidden" id="raw_width_store" value="{{ raw_width }}">

            <div class="box" style="border-color: #FFD700;">
                <h2 style="color: #FFD700;">// ANALYSIS COMPLETE</h2>
                <div class="results-grid">
                    <div>
                        <img src="data:image/jpeg;base64,{{ image_data }}" style="width: 100%; border-radius: 8px; border: 1px solid #30363d;">
                    </div>
                    <div>
                        <div class="metric-box" style="border-color: #FFD700;">
                            <div class="metric-label" style="color: #FFD700;">REAL WORLD WIDTH (FT)</div>
                            <input type="number" id="real_width_input" class="calib-input" value="50" oninput="recalc()">
                        </div>

                        <div class="metric-box"><div class="metric-val" id="display_feet">---</div><div class="metric-label">TOTAL LINEAR FEET</div></div>
                        <div class="metric-box"><div class="metric-val" id="display_cost">---</div><div class="metric-label">ESTIMATED COST</div></div>
                        
                        <form id="download_form" action="/download_report" method="post">
                            <input type="hidden" name="final_feet" id="hidden_feet">
                            <input type="hidden" name="final_cost" id="hidden_cost">
                            <input type="hidden" name="final_sheets" id="hidden_sheets">
                            <input type="hidden" name="final_paint" id="hidden_paint">
                            
                            <button type="button" onclick="startPayment()" class="btn-pay">
                                üîí UNLOCK & DOWNLOAD (‚Çπ199)
                            </button>
                        </form>

                    </div>
                </div>
            </div>
            <script>recalc();</script>
            {% endif %}
        {% endif %}
    </div>
</body>
</html>